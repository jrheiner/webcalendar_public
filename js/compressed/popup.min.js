console.info(`${logPreface("JS")} popup.js loaded`),$(function(){$("#modal-delete").on("show.bs.modal",function(a){let b=$(a.relatedTarget),c=b.data("name"),d=b.data("start"),e=b.data("end"),f=b.data("organizer"),g=b.data("id"),h=$(this);console.log(`${logPreface("EVENT")} Delete confirmation: ${c}`),h.find(".modal-title").html(`Delete <i>${c}</i>?`),h.find("#delete-event").html(`<b>Name:</b> ${c}<span class='text-muted'> (Id: ${g})</span>`),h.find("#delete-time").html(`<b>Time:</b> ${doubleDateTimeDisplay(d,e)}`),h.find("#delete-organizer").html(`<b>Organizer:</b> ${f}`),h.find("#delete-confirm").off("click").on("click",function(){$("#modal-delete").modal("hide"),deleteEvent(g).then(function(){getEvents().then(function(a){try{initListOfEvents(a,"new",!0)}catch(a){$("#eventListModal").trigger("event:change"),$("#calendar-root").trigger("event:change")}}).catch(function(a){console.warn(a)})}).catch(function(a){$("#modal-delete").modal("hide"),console.warn(a)})})}),$("#modal-details").on("show.bs.modal",function(a){let b=$(a.relatedTarget),c=b.data("id"),d=$(this);console.log(`${logPreface("EVENT")} Show details: id=${c}`),getEventsDetails(c).then(function(a){let b=a.title,e=a.start,f=a.end,g=` <a href="mailto:${a.organizer}">${a.organizer}</a>`,h=a.location?`${a.location} <a href="http://maps.google.com/?q=${a.location}" target="_blank" rel="noopener">(Search on Google Maps)</a>`:"No location available.",i=a.status,j=a.webpage?`<a href="${a.webpage}">${a.webpage}</a>`:"No webpage available.",k=a.imageurl||`img/default/${getDefaultImage()}_placeholder.png`,l=a.categories,m=a.extra||"No description available";switch(i){case"Busy":i=`<h4><span class="badge status-blue striped">Busy</span></h4>`;break;case"Tentative":i=`<h4><span class="badge status-blue stripes">Tentative</span></h4>`;break;case"Free":i=`<h4><span class="badge status-purple stripes">Free</span></h4>`;break;default:i=`<h4><span class="badge badge-warning">No status</span></h4>`;}d.find(".modal-title").html(`<i>${b}</i> details`),d.find(".card-title").text(b),d.find("#modal-details-time").html(`${doubleDateTimeDisplay(e,f)}&emsp;${i}`),d.find("#popup-modal-img").attr("src",k),d.find("#modal-details-org-loc").html(`Organized by <i>${g}</i>, Location: <i>${h}</i>`),d.find("#modal-details-web").html(j),d.find("#modal-details-extra").text(m);let n="";l.length?l.forEach(a=>{n=`${n}<span class='badge badge-pill badge-secondary'> ${a.name}</span> `}):n="No categories assigned.",d.find("#modal-details-category").html(n);let o=new Date(e).toISOString().replace(/-|:|\.|Z/gi,"").slice(0,-3),p=new Date(f).toISOString().replace(/-|:|\.|Z/gi,"").slice(0,-3);d.find("#download-ics").attr("href",`data:text/calendar;charset=utf8,${escape(createICSString(c,b,a.organizer,a.webpage,a.location,m,o,p))}`).attr("download",`${b}.ics`)}).catch(function(a){console.warn(a)})}),$("#modal-edit").on("show.bs.modal",function(a){let b;$("#editForm").removeClass("was-validated"),$("#editForm")[0].reset(),"Choose file..."!=$(".custom-file-label").text()&&$(".custom-file-label").text("Choose file..."),$("#form-fileupload-preview").attr("src",`img/default/${getDefaultImage()}_placeholder.png`),$("#fileupload-feedback").html(""),$("#fileupload-delete").css("display","none");let c=$(a.relatedTarget),d=$(this),e=c.data("id")||"";if(""==e){b=!0,$("#edit-form-save").html("Add event").prop("disabled",!1),d.find(".modal-title").html("Add new event"),console.log(`${logPreface("EVENT")} Add event modal`);let a=new Date;d.find("#input-start-date").val(a.toISOString().substring(0,10)),d.find("#input-end-date").val(a.toISOString().substring(0,10)),a.setHours(a.getHours()+1),d.find("#input-start-time").val(`${a.getHours()}:00`),a.setHours(a.getHours()+1),d.find("#input-end-time").val(`${a.getHours()}:00`),getCategoriesForEvent("")}else getEventsDetails(e).then(function(a){let b=a.title,c=a.start,f=a.end,g=a.organizer,h=a.location,i=a.status,j=a.imageurl,k=a.webpage,l=a.categories,m=a.extra;if($("#fileupload-delete").attr("data-id",e),$("#edit-form-save").html("Save edits").prop("disabled",!1),d.find(".modal-title").html(`Edit <i>${b}</i> details`),console.log(`${logPreface("EVENT")} Edit modal: ${b}`),d.find("#input-title").val(b),d.find("#input-location").val(h),d.find("#input-organizer").val(g),d.find("#input-start-date").val(c.substring(0,10)),d.find("#input-end-date").val(f.substring(0,10)),d.find("#input-start-time").val(`${addLeadingZero(new Date(c).getHours())}:${addLeadingZero(new Date(c).getMinutes())}`),d.find("#input-end-time").val(`${addLeadingZero(new Date(f).getHours())}:${addLeadingZero(new Date(f).getMinutes())}`),null!=j){$("#fileupload-delete").css("display","block"),$("#form-fileupload-preview").attr("src",j);let a=j.split(/[\/ ]+/).pop();$(".custom-file-label").text(a)}d.find("#input-web").val(k),d.find("#input-status").val(i),getCategoriesForEvent(l),d.find("#form-textarea").val(m)}).catch(function(a){console.warn(a)});$("#fileupload-delete").off("click").on("click",function(a){let b=$(a.target).data("id");$(this).prop("disabled",!0),deleteImageFromEvent(b).then(function(){$(".custom-file-label").text("Choose file..."),$("#form-fileupload-preview").attr("src",`img/default/${getDefaultImage()}_placeholder.png`),$(`#event-${b}`).find("img").attr("src",`img/default/${getDefaultImage()}_placeholder.png`),$("#fileupload-delete").trigger("mouseleave"),$("#fileupload-delete").css("display","none"),$("#fileupload-delete").prop("disabled",!1)}).catch(function(a){console.warn(a),$("#fileupload-delete").prop("disabled",!1)})}),$(function(){$("#fileupload-delete").hover(function(){$("#form-fileupload-preview").css("border-color","#dc3545"),$("#form-fileupload-preview").css("opacity","0.5")},function(){$("#form-fileupload-preview").css("border-color","#dee2e6"),$("#form-fileupload-preview").css("opacity","1")})}),$("#edit-form-save").off("click").on("click",function(){if($("#edit-form-submit").trigger("click"),!0===$("#editForm")[0].checkValidity()){$(this).html(`Adding event <div class="spinner-border spinner-border-sm" role="status">`),$(this).prop("disabled",!0);let a,c=document.querySelector("input[type=file]").files[0],d=new FileReader;d.onloadend=function(){a=d.result,b?initAddEvent(a):initEditEvent(e,a)},null==c?b?initAddEvent():initEditEvent(e):d.readAsDataURL(c)}})})});function initAddEvent(a=null){let b=formToJson($("#editForm"),a);addEvent(b).then(function(){$(this).html("Add event"),$(this).prop("disabled",!0),$("#modal-edit").modal("hide"),getEvents().then(function(a){try{initListOfEvents(a,"new",!0)}catch(a){$("#calendar-root").trigger("event:change")}}).catch(function(a){console.warn(a)})}).catch(function(a){console.warn(a),$(this).html("Add event"),$(this).prop("disabled",!1),$("#modal-edit").modal("hide")})}function initEditEvent(a,b=null){let c=formToJson($("#editForm"),b);editEvent(c,a).then(function(){$(this).html("Save"),$(this).prop("disabled",!0),$("#modal-edit").modal("hide"),getEvents().then(function(a){try{initListOfEvents(a,"new",!0)}catch(a){$("#eventListModal").trigger("event:change"),$("#calendar-root").trigger("event:change")}}).catch(function(a){console.warn(a)})}).catch(function(a){console.warn(a),$(this).html("Save"),$(this).prop("disabled",!1),$("#modal-edit").modal("hide")})}$(function(){$(function(){let a=document.getElementById("editForm");a.addEventListener("submit",function(b){!1===a.checkValidity()&&(b.preventDefault(),b.stopPropagation()),a.classList.add("was-validated")},!1)}),$(".custom-file-input").on("change",function(){let a=$("#form-fileupload-preview"),b=document.querySelector("input[type=file]").files;validImageTypes=["image/jpeg","image/png"];let c=-1<$.inArray(b[0].type,validImageTypes),d=5e5>b[0].size;if(b&&b[0]&&d&&c){let c=new FileReader;c.onload=function(c){$("#fileupload-feedback").html(`<span class="text-success font-italic">Valid file. <svg width="1.5em" height="1.5em" viewBox="0 0 16 16" class="bi bi-file-earmark-check-fill" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" d="M2 3a2 2 0 0 1 2-2h5.293a1 1 0 0 1 .707.293L13.707 5a1 1 0 0 1 .293.707V13a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V3zm7 2V2l4 4h-3a1 1 0 0 1-1-1zm1.854 2.854a.5.5 0 0 0-.708-.708L7.5 9.793 6.354 8.646a.5.5 0 1 0-.708.708l1.5 1.5a.5.5 0 0 0 .708 0l3-3z"/>
              </svg><br>${b[0].type}, ${+(b[0].size/1e3)}kb</span>`),$("#form-fileupload")[0].setCustomValidity(""),a.attr("src",c.target.result)},c.readAsDataURL(b[0])}else $("#fileupload-feedback").html(`<span class='text-danger font-italic'>Invalid file. <svg width="1.5em" height="1.5em" viewBox="0 0 16 16" class="bi bi-file-earmark" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 1h5v1H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V6h1v7a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2z"/>
            <path d="M9 4.5V1l5 5h-3.5A1.5 1.5 0 0 1 9 4.5z"/>
            <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/>
          </svg><br>${b[0].type}, ${+(b[0].size/1e3)}kb</span>`),$("#form-fileupload")[0].setCustomValidity("Invalid file."),a.attr("src",`img/default/${getDefaultImage()}_placeholder.png`);let e=$(this).val().split("\\").pop();$(this).siblings(".custom-file-label").addClass("selected").html(e),$("#fileupload-delete").css("display","none")})});function validateEventDate(){let a=!0,b=!0,c=new Date,d=document.getElementById("input-start-date"),e=document.getElementById("input-end-date"),f=new Date(d.value),g=new Date(e.value);validateEventTime(),f>g&&(e.setCustomValidity("Invalid start date"),$("#input-end-date-feedback").html("End date can not be earlier then start date!"),b=!1),f<c&&new Date(f.toDateString()).valueOf()!=new Date(c.toDateString()).valueOf()&&(d.setCustomValidity("Invalid start date"),$("#input-start-date-feedback").html("Start date can not be in the past!"),a=!1),g<c&&new Date(g.toDateString()).valueOf()!=new Date(c.toDateString()).valueOf()&&(e.setCustomValidity("Invalid end date"),$("#input-end-date-feedback").html("End date can not be in the past!"),b=!1),a&&(d.setCustomValidity(""),$("#input-start-date-feedback").html("")),b&&(e.setCustomValidity(""),$("#input-end-date-feedback").html(""))}function validateEventTime(){let a=!0,b=document.getElementById("input-start-time"),c=document.getElementById("input-end-time"),d=new Date(`2020-01-01T${b.value}:00`),e=new Date(`2020-01-01T${c.value}:00`),f=new Date(document.getElementById("input-start-date").value),g=new Date(document.getElementById("input-end-date").value),h=isSameDay(f,g);d>e&&h&&(c.setCustomValidity("Invalid end time"),$("#input-end-time-feedback").html("End time can not be earlier then start time!"),a=!1),b.setCustomValidity(""),$("#input-start-time-feedback").html(""),a&&(c.setCustomValidity(""),$("#input-end-time-feedback").html(""))}